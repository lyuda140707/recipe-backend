from aiogram import Bot, Dispatcher, types
from aiogram.types import InlineKeyboardMarkup, InlineKeyboardButton, WebAppInfo
from aiogram.utils import executor
from aiogram.dispatcher.filters import Command
import os
from pro_utils import add_pro_user

API_TOKEN = os.getenv("BOT_TOKEN")
ADMIN_CHAT_ID = int(os.getenv("ADMIN_CHAT_ID"))

print("üßæ ADMIN_CHAT_ID =", ADMIN_CHAT_ID)

bot = Bot(token=API_TOKEN)
Bot.set_current(bot)
dp = Dispatcher(bot)


@dp.message_handler(commands=["start"])
async def send_welcome(message: types.Message):
    keyboard = InlineKeyboardMarkup(inline_keyboard=[
        [InlineKeyboardButton(
            text="üì± –í—ñ–¥–∫—Ä–∏—Ç–∏ –º–µ–Ω—é",
            web_app=WebAppInfo(url="https://lyuda140707.github.io/telegram-recipe-webapp/")
        )]
    ])
    await message.answer("–ü—Ä–∏–≤—ñ—Ç! üëã –©–æ–± –ø–æ—á–∞—Ç–∏ ‚Äî –Ω–∞—Ç–∏—Å–Ω–∏ –∫–Ω–æ–ø–∫—É –Ω–∏–∂—á–µ üëá", reply_markup=keyboard)


@dp.message_handler(Command("ok"))
async def approve_pro(message: types.Message):
    if str(message.chat.id) != os.getenv("ADMIN_CHAT_ID"):
        await message.reply("‚õî –¢–æ–±—ñ –Ω–µ –¥–æ–∑–≤–æ–ª–µ–Ω–æ —Ü–µ —Ä–æ–±–∏—Ç–∏.")
        return

    try:
        args = message.text.split()
        if len(args) < 2:
            await message.reply("‚ùå –í–∫–∞–∂–∏ ID –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –ø—ñ—Å–ª—è /ok")
            return

        user_id = int(args[1])
        username = None
        name = "–û–ø–ª–∞—Ç–∞ –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–∞ –≤—Ä—É—á–Ω—É"

        add_pro_user(user_id, username or "", name)
        await message.reply(f"‚úÖ PRO –¥–æ—Å—Ç—É–ø –∞–∫—Ç–∏–≤–æ–≤–∞–Ω–æ –¥–ª—è ID {user_id}")
        await bot.send_message(user_id, "üéâ –¢–≤—ñ–π PRO –¥–æ—Å—Ç—É–ø –∞–∫—Ç–∏–≤–æ–≤–∞–Ω–æ! –î—è–∫—É—î–º–æ –∑–∞ –ø—ñ–¥—Ç—Ä–∏–º–∫—É!")

    except Exception as e:
        await message.reply(f"‚ùå –ü–æ–º–∏–ª–∫–∞: {e}")


@dp.channel_post_handler(content_types=types.ContentType.VIDEO)
async def handle_any_channel_post(post: types.Message):
    print("‚úÖ –°–ü–†–ê–¶–Æ–í–ê–í channel_post_handler")

    try:
        file_id = post.video.file_id
        print(f"üéØ –ó–Ω–∞–π–¥–µ–Ω–æ –≤—ñ–¥–µ–æ, file_id: {file_id}")
        
        await bot.send_message(
            ADMIN_CHAT_ID,
            f"üé• –í—ñ–¥–µ–æ –∑ –∫–∞–Ω–∞–ª—É:\n<code>{file_id}</code>",
            parse_mode="HTML"
        )
        print("‚úÖ file_id –Ω–∞–¥—ñ—Å–ª–∞–Ω–æ —É—Å–ø—ñ—à–Ω–æ")
    except Exception as e:
        print("‚ùå –ü–û–ú–ò–õ–ö–ê:", repr(e))
